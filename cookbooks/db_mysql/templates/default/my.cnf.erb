# 
# Cookbook Name:: db_mysql
#
# Copyright RightScale, Inc. All rights reserved.  All access and use subject to the
# RightScale Terms of Service available at http://www.rightscale.com/terms.php and,
# if applicable, other agreements such as a RightScale Master Subscription Agreement.
# 
# Managed by RightScale
# DO NOT EDIT BY HAND
#

# Generated by Chef for <%= node[:hostname] %>
#
# Local modifications will be overwritten.
# 
# The MySQL database server configuration file.
#
# For explanations see
# http://dev.mysql.com/doc/mysql/en/server-system-variables.html

[client]
port            = 3306
socket          = <%= node[:db_mysql][:socket] %>

[mysqld_safe]
socket          = <%= node[:db_mysql][:socket] %>
nice            = 0

[mysqld]
#
# * Basic Settings
#
user            = mysql
#pid-file        = /var/run/mysqld/mysqld.pid
socket          = <%= node[:db_mysql][:socket] %>
port            = 3306
datadir         = <%= node[:db_mysql][:datadir] %>
tmpdir          = <%= node[:db_mysql][:tmpdir] %>

skip-external-locking
bind-address            = <%= node[:db_mysql][:bind_address] %>
#
# * Fine Tuning
#
key_buffer              = <%= node[:db_mysql][:tunable][:key_buffer] %>
max_allowed_packet      = 16M
thread_stack            = 192K
thread_cache_size       = <%= node[:db_mysql][:tunable][:thread_cache_size] %>
myisam-recover          = BACKUP
max_connections         = <%= node[:db_mysql][:tunable][:max_connections] %>
wait_timeout            = <%= node[:db_mysql][:tunable][:wait_timeout] %>
net_read_timeout        = <%= node[:db_mysql][:tunable][:net_read_timeout] %>
net_write_timeout       = <%= node[:db_mysql][:tunable][:net_write_timeout] %>
back_log                = <%= node[:db_mysql][:tunable][:back_log] %>
table_cache             = <%= node[:db_mysql][:tunable][:table_cache] %>
max_heap_table_size     = <%= node[:db_mysql][:tunable][:max_heap_table_size] %>

sort_buffer_size        = <%= node[:db_mysql][:tunable][:sort_buffer_size] %>
read_buffer_size        = <%= node[:db_mysql][:tunable][:read_buffer_size] %>
read_rnd_buffer_size    = <%= node[:db_mysql][:tunable][:read_rnd_buffer_size] %>
myisam_sort_buffer_size = <%= node[:db_mysql][:tunable][:myisam_sort_buffer_size] %>
net_buffer_length       = <%= node[:db_mysql][:tunable][:net_buffer_length] %>

#
# * Query Cache Configuration
#
query_cache_limit       = 1M
query_cache_size        = <%= node[:db_mysql][:tunable][:query_cache_size] %>

#
# * Logging and Replication
#
<%= node[:db_mysql][:log] %>
<%= node[:db_mysql][:log_error] %>
<%= node[:db_mysql][:tunable][:log_slow_queries] %>
<%= node[:db_mysql][:tunable][:long_query_time] %>
log-queries-not-using-indexes

<%= "read_only = 1" unless node[:db_mysql][:tunable][:read_only] == nil %>
server-id               = <%= @server_id %>
<% if node[:db_mysql][:log_bin_enabled] %>
<%= "log_bin = #{node[:db_mysql][:log_bin]}" %>
<%= "expire_logs_days        = #{node[:db_mysql][:tunable][:expire_logs_days]}" %>
<% end %>
max_binlog_size         = 100M
#
# * InnoDB
#

<% if node[:db_mysql][:version] == '5.1' %>
  # On MySQL 5.1, load the innodb plugin
  ignore-builtin-innodb
  plugin-load=innodb=ha_innodb_plugin.so
<% end %>

innodb_data_home_dir = /var/lib/mysql/
innodb_data_file_path = ibdata1:10M:autoextend
innodb_log_group_home_dir = /var/lib/mysql

<% if node[:db_mysql][:version] == '5.5' %>
# some MySQL 5.5 specific config
<% end %>

innodb_file_per_table
innodb_buffer_pool_size = <%= node[:db_mysql][:tunable][:innodb_buffer_pool_size] %>
innodb_additional_mem_pool_size = <%= node[:db_mysql][:tunable][:innodb_additional_mem_pool_size] %>
innodb_log_file_size = <%= node[:db_mysql][:tunable][:innodb_log_file_size] %>
innodb_log_buffer_size = <%= node[:db_mysql][:tunable][:innodb_log_buffer_size] %>
innodb_flush_log_at_trx_commit = 2
innodb_lock_wait_timeout = 50
innodb_support_xa = 1
innodb_flush_method=O_DIRECT
innodb_fast_shutdown = 1

log-bin=<%=node[:db_mysql][:log_bin] %>

relay-log-index=<%= node[:db][:data_dir] %>/<%= node[:hostname] %>-relay-log.index
relay-log=<%= node[:db][:data_dir] %>/<%= node[:hostname] %>-relay-bin

[mysqldump]
quick
quote-names
max_allowed_packet      = 16M

[mysql]

<% if node[:db_mysql][:version] == '5.1' %>
# isam dropped after version 5.1
[isamchk]
key_buffer        = <%= node[:db_mysql][:tunable][:isamchk][:key_buffer] %>
sort_buffer_size        = <%= node[:db_mysql][:tunable][:isamchk][:sort_buffer_size] %>
<% end %>

[myisamchk]
key_buffer        = <%= node[:db_mysql][:tunable][:myisamchk][:key_buffer] %>
sort_buffer_size        = <%= node[:db_mysql][:tunable][:myisamchk][:sort_buffer_size] %>

# * IMPORTANT: Additional settings that can override those from this file!
#   The files must end with '.cnf', otherwise they'll be ignored.
#
!includedir /etc/mysql/conf.d/
